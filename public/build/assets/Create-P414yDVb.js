import{r as n,j as e,a as ae}from"./app-CiDaUcey.js";import{P as te,b as re,d as oe,y as x}from"./PortalLayout-CxqdbcvG.js";import{u as le}from"./useErrorToast-CTAe8NjK.js";import{S as T}from"./react-select.esm-Le_u87zZ.js";import{S as p}from"./sweetalert2.esm.all-89IKscqO.js";import{x as U}from"./useData-CInDpAgI.js";import{R as _}from"./Row-DoEZsrd7.js";import{C as j}from"./Col-H7LL1jeG.js";import{C as N}from"./Card-O6qekqvm.js";import{B as V}from"./ButtonGroup-Bf8VZ0Fe.js";import{B as k}from"./warning-CDyBO85i.js";import{I as b}from"./InputGroup-B5mTNa8N.js";import{b as ne,F as ie,c as z}from"./Form-DY59OgGH.js";import{T as ce}from"./Table-CC8sxR3u.js";import{D as ue}from"./download-c8zlRh80.js";import"./CloseButton-uf0rwOsm.js";import"./ElementChildren-Ykn35dyp.js";function ke({classes:v,subjects:B}){const{showErrorToast:D}=le(),[W]=n.useState("normal"),[d,I]=n.useState(null),[h,F]=n.useState(null),[m,R]=n.useState(null),[L,M]=n.useState([]),[P,q]=n.useState(null),[g,E]=n.useState({}),[i,H]=n.useState(!1),[c,G]=n.useState(!1),[u,A]=n.useState(!1),[S,$]=n.useState(100),[y,Y]=n.useState(100),[w,J]=n.useState(100),[O,K]=n.useState(100),X=t=>{var r;I(t),F(null);const a=v.find(s=>s.id===(t==null?void 0:t.value));M(((r=a==null?void 0:a.class_streams)==null?void 0:r.map(s=>{var o;return{value:s.id,label:(o=s.stream)==null?void 0:o.name}}))||[])},Z=()=>{I(null),F(null),R(null),M([]),q(null),E({})},ee=async()=>{if(!d)return x.warning("Please select a class.");if(!m)return x.warning("Please select a subject.");const t={examType:W,classId:d==null?void 0:d.value,streamId:h==null?void 0:h.value,subjectId:m==null?void 0:m.value};try{p.fire({title:"Processing...",text:"Please wait while we process your request.",allowOutsideClick:!1,didOpen:()=>p.showLoading()});const{data:a}=await U.post(route("admin.result.request"),t);if(!a.success)return x.error("Error occurred while fetching marks list.");x.success(a.message),q(a.data);const r={};if(a.data.students.forEach(s=>{var o,l,f,C;r[s.id]={score:((o=s.result)==null?void 0:o.score)||"",P1:((l=s.result)==null?void 0:l.P1)||"",P2:((f=s.result)==null?void 0:f.P2)||"",P3:((C=s.result)==null?void 0:C.P3)||""}}),E(r),a.data.students.some(s=>s.result)){const s=a.data.students[0].result;$((s==null?void 0:s.score_outof)||100),Y((s==null?void 0:s.P1_outof)||100),J((s==null?void 0:s.P2_outof)||100),K((s==null?void 0:s.P3_outof)||100)}H(s=>s||a.data.students.some(o=>{var l;return parseFloat((l=o.result)==null?void 0:l.P1)>0})),G(s=>s||a.data.students.some(o=>{var l;return parseFloat((l=o.result)==null?void 0:l.P2)>0})),A(s=>s||a.data.students.some(o=>{var l;return parseFloat((l=o.result)==null?void 0:l.P3)>0}))}catch(a){D(a)}finally{p.close()}},Q=(t,a,r)=>{const s={...g,[t]:{...g[t],[a]:r}};if(i||c||u){const o=[i?(parseFloat(s[t].P1)||0)*(100/y):0,c?(parseFloat(s[t].P2)||0)*(100/w):0,u?(parseFloat(s[t].P3)||0)*(100/O):0],l=[i,c,u].filter(Boolean).length;s[t].score=(o.reduce((f,C)=>f+C,0)/l*(S/100)).toFixed(2)}E(s)},se=async()=>{if(!P)return x.warning("No marks entry list to save.");if((await p.fire({title:"Save Marks?",text:"Do you want to submit the entered marks?",icon:"question",showCancelButton:!0,confirmButtonColor:"#198754",cancelButtonColor:"#d33",confirmButtonText:"Yes, Save"})).isConfirmed)try{p.fire({title:"Submitting...",text:"Please wait while we save marks.",allowOutsideClick:!1,didOpen:()=>p.showLoading()});const a={examId:P.exam.id,classId:d==null?void 0:d.value,streamId:h==null?void 0:h.value,subjectId:m==null?void 0:m.value,scores:g,outOf:{score:S,P1:i?y:null,P2:c?w:null,P3:u?O:null}},{data:r}=await U.post(route("admin.result.store"),a);r.success?x.success(r.message||"Marks saved successfully!"):x.error(r.message||"Failed to save marks.")}catch(a){D(a)}finally{p.close()}};return e.jsxs(te,{children:[e.jsx(ae,{title:"Exam Marks Entry"}),e.jsx(_,{children:e.jsx(j,{md:12,children:P?e.jsx(N,{children:e.jsxs(N.Body,{children:[e.jsxs("div",{className:"d-flex justify-content-between align-items-center",children:[e.jsx("h5",{className:"mb-0",children:P.exam.name}),e.jsxs(V,{className:"gap-2",children:[e.jsxs(k,{size:"sm",variant:"outline-primary",as:"a",href:route("admin.result.create"),children:[e.jsx(re,{className:"me-1"}),"Back"]}),e.jsxs(k,{size:"sm",variant:"outline-success",onClick:se,children:[e.jsx(oe,{className:"me-1"}),"Save"]})]})]}),e.jsx("hr",{className:"dashed-hr"}),e.jsx("div",{className:"bg-light border rounded p-2 mb-3",children:e.jsx(_,{className:"g-2",children:[{label:"Paper 1",state:i,set:H,outOf:y,setOutOf:Y},{label:"Paper 2",state:c,set:G,outOf:w,setOutOf:J},{label:"Paper 3",state:u,set:A,outOf:O,setOutOf:K}].map(({label:t,state:a,set:r,outOf:s,setOutOf:o},l)=>e.jsx(j,{md:4,children:e.jsxs(b,{className:"border rounded",children:[e.jsx(b.Text,{className:"bg-light border-0",children:e.jsx(ne,{type:"checkbox",label:`Has ${t}`,checked:a,onChange:()=>r(!a),className:"m-0"})}),a&&e.jsxs(e.Fragment,{children:[e.jsx(b.Text,{className:"bg-light border-0",children:"/"}),e.jsx(ie.Control,{type:"number",min:1,value:s,onChange:f=>o(parseInt(f.target.value)||100),className:"bg-light border-0 text-center fw-semibold"})]})]})},l))})}),e.jsxs(ce,{striped:!0,bordered:!0,hover:!0,responsive:!0,children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Adm"}),e.jsx("th",{children:"Name"}),i&&e.jsxs("th",{children:["Paper 1 (",y,")"]}),c&&e.jsxs("th",{children:["Paper 2 (",w,")"]}),u&&e.jsxs("th",{children:["Paper 3 (",O,")"]}),e.jsx("th",{children:e.jsxs(b,{className:"border-0",children:[e.jsxs(b.Text,{className:"bg-transparent border-0 fw-semibold",children:["Score (",S,")"]}),!i&&!c&&!u&&e.jsx(z,{type:"number",value:S,onChange:t=>$(parseInt(t.target.value)||100),className:"bg-light border-0 fw-semibold p-0 ps-2"})]})})]})}),e.jsx("tbody",{children:P.students.map(t=>{var a;return e.jsxs("tr",{children:[e.jsx("td",{children:t.admission_number}),e.jsx("td",{children:t.user.full_name}),["P1","P2","P3"].map(r=>{var s;return(r==="P1"&&i||r==="P2"&&c||r==="P3"&&u)&&e.jsx("td",{children:e.jsx(z,{size:"sm",type:"number",value:((s=g[t.id])==null?void 0:s[r])||"",onChange:o=>Q(t.id,r,o.target.value)})},r)}),e.jsx("td",{children:e.jsx(z,{size:"sm",type:"number",value:((a=g[t.id])==null?void 0:a.score)||"",readOnly:i||c||u,onChange:r=>Q(t.id,"score",r.target.value)})})]},t.id)})})]})]})}):e.jsx(N,{children:e.jsxs(N.Body,{children:[e.jsx("div",{className:"d-flex justify-content-between align-items-center",children:e.jsx("h5",{className:"mb-0",children:"Request marks entry list"})}),e.jsx("hr",{className:"dashed-hr"}),e.jsxs(_,{className:"g-3",children:[e.jsx(j,{md:3,children:e.jsx(T,{options:v==null?void 0:v.map(({id:t,name:a})=>({value:t,label:a})),placeholder:"Select class",onChange:X,value:d})}),e.jsx(j,{md:3,children:e.jsx(T,{options:L,placeholder:"Select stream",value:h,onChange:F,isDisabled:!L.length})}),e.jsx(j,{md:3,children:e.jsx(T,{options:B==null?void 0:B.map(({id:t,name:a})=>({value:t,label:a})),placeholder:"Select subject",value:m,onChange:R})}),e.jsx(j,{md:3,children:e.jsxs(V,{className:"d-flex gap-2",children:[e.jsxs(k,{size:"sm",variant:"outline-primary",onClick:ee,children:[e.jsx(ue,{className:"me-1"}),"Get"]}),e.jsx(k,{size:"sm",variant:"outline-danger",onClick:Z,children:"Reset"})]})})]})]})})})})]})}export{ke as default};
